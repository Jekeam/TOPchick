<pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1052 or 1052 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1052 or 1052 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1033 or 1033 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1033 or 1033 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1018 or 1018 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1018 or 1018 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1006 or 1006 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 1006 or 1006 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 993 or 993 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 993 or 993 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 990 or 990 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 990 or 990 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 954 or 954 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 954 or 954 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 976 or 976 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 976 or 976 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 965 or 965 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 965 or 965 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 946 or 946 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 946 or 946 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 935 or 935 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 935 or 935 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 930 or 930 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 930 or 930 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 919 or 919 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 919 or 919 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 914 or 914 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 914 or 914 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 906 or 906 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 906 or 906 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 892 or 892 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 892 or 892 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 882 or 882 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 882 or 882 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 804 or 804 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 804 or 804 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 867 or 867 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 867 or 867 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 858 or 858 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 858 or 858 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 839 or 839 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 839 or 839 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 831 or 831 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 831 or 831 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 819 or 819 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 819 or 819 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 809 or 809 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 809 or 809 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 795 or 795 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 795 or 795 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 748 or 748 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 748 or 748 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 581 or 581 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 581 or 581 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 564 or 564 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 564 or 564 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 559 or 559 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 559 or 559 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 484 or 484 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 484 or 484 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 550 or 550 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 550 or 550 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 512 or 512 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 512 or 512 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 498 or 498 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 498 or 498 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 487 or 487 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 487 or 487 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 475 or 475 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 475 or 475 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 469 or 469 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 469 or 469 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 463 or 463 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 463 or 463 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 453 or 453 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 453 or 453 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 443 or 443 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 443 or 443 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 440 or 440 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 440 or 440 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 434 or 434 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 434 or 434 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 430 or 430 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 430 or 430 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 425 or 425 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 425 or 425 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 421 or 421 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 421 or 421 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 418 or 418 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 418 or 418 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 409 or 409 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 409 or 409 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 389 or 389 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 389 or 389 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 386 or 386 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 386 or 386 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 393 or 393 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 393 or 393 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 370 or 370 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 370 or 370 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 360 or 360 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 360 or 360 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 346 or 346 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 346 or 346 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 327 or 327 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 327 or 327 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 316 or 316 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 316 or 316 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 299 or 299 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 299 or 299 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 285 or 285 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 285 or 285 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 266 or 266 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 266 or 266 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 251 or 251 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 251 or 251 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre><pre>SELECT 
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 3
             and place != 0
             and data <= '2018-07-19'
             and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top3,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 10
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top10,
        
        (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where place <= 30
            and place != 0
            and data <= '2018-07-19'
            and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                group by key_id
            )
        ) as top30,
        
        COALESCE(ROUND(
            (select sum(case 
                        when place <= 3 then 1
                        when place = 4 then 0.85
                        when place = 5 then 0.6
                        when place in (6,7)  then 0.5
                        when place in (8,9) then 0.3
                        when place = 10 then 0.2
                    end)
            from wp_tch_serp
            where place != 0
              and data <= '2018-07-19'
              and (key_id, data) in (
                select key_id, max(data) date
                from wp_tch_serp
                where data <= '2018-07-19'
                 group by key_id
                )
            ),1), 0) as visibility_serp
                    
         ,COALESCE(
            (SELECT sum(case when a.place < b.place then b.place-a.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 224 or 224 = 0
            )
        , 0) as pos_improved
          
        ,COALESCE(
            (SELECT sum(case when a.place > b.place then a.place-b.place else 0 end)
            FROM wp_tch_serp a
            JOIN wp_tch_serp b on a.key_id = b.key_id
              and a.data = (select max(t1.data) from wp_tch_serp t1 where t1.data <= '2018-07-19')/*берем послед срез*/
              and b.data = (select max(t2.data) from wp_tch_serp t2 
                            where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
              and t2.data <= '2018-07-19')/*берем предпосл срез*/
              and a.data <= '2018-07-19'
              and b.data <= '2018-07-19'
              and a.place != 0
              and b.place != 0
            JOIN wp_tch_keywords c on c.key_id = a.key_id and c.key_id = b.key_id
            WHERE c.post_id = 224 or 224 = 0
              )
        , 0) as pos_deteriorated
          
         ,COALESCE((SELECT sum(b.place)
           FROM wp_tch_serp b
           WHERE b.data = (select max(t2.data) from wp_tch_serp t2 
                           where t2.data != (select max(t3.data) from wp_tch_serp t3 where t3.data <= '2018-07-19')
                             and t2.data <= '2018-07-19')/*берем предпосл срез*/
             and b.data <= '2018-07-19'
             and b.place != 0), 0) 
          as pos_available,
          
          (
            select count(distinct key_id) cnt
            from wp_tch_serp
            where data = '2018-07-19'
              and place != 0
          ) as cnt_cur_pos,
          
          
         (SELECT count(*) FROM wp_tch_keywords i) count_all</pre>